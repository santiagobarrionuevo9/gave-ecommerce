<div class="container py-4 admin-page" *ngIf="!loading(); else loadingTpl">
  <ng-container *ngIf="!error; else errorTpl">

    <div class="d-flex justify-content-between align-items-center mb-3 admin-header">
      <div>
        <h4 class="mb-0">Pedido #{{ order.id }}</h4>
        <p class="text-muted small mb-0">
          {{ order.buyerEmail }} · {{ order.buyerPhone || 'Sin teléfono' }}
        </p>
      </div>
      <a routerLink="/admin/pedidos" class="btn btn-outline-secondary btn-sm">
        ← Volver
      </a>
    </div>

    <div class="row g-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm order-detail-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">{{ order.buyerName }}</div>
                <div class="text-muted small">
                  {{ order.buyerEmail }} · {{ order.buyerPhone || '—' }}
                </div>
              </div>
              <span [class]="badgeCls(order.status)">{{ order.status }}</span>
            </div>

            <hr>

            <div class="small text-muted mb-2">
              Creado: {{ order.createdAt | date:'short' }} ·
              Actualizado: {{ order.updatedAt | date:'short' }}
            </div>

            <div *ngIf="order.address" class="mb-3">
              <div class="fw-semibold">Envío</div>
              <div>{{ order.address.street }} {{ order.address.number || '' }}</div>
              <div class="text-muted small">
                {{ order.address.city }}, {{ order.address.province }} ({{ order.address.postalCode || '-' }})
              </div>
              <div class="text-muted small" *ngIf="order.address.reference">
                Ref: {{ order.address.reference }}
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle admin-table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th class="text-end">Cant.</th>
                    <th class="text-end">Unit.</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let it of order.items">
                    <td>#{{ it.productId }} · {{ it.productName }}</td>
                    <td class="text-end">{{ it.quantity }}</td>
                    <td class="text-end">$ {{ it.unitPrice | number:'1.0-0' }}</td>
                    <td class="text-end">$ {{ it.lineTotal | number:'1.0-0' }}</td>
                  </tr>
                </tbody>
                <tfoot class="order-totals">
                  <tr>
                    <th colspan="3" class="text-end">Subtotal</th>
                    <th class="text-end">$ {{ order.itemsTotal | number:'1.0-0' }}</th>
                  </tr>
                  <tr *ngIf="order.deliveryCost">
                    <th colspan="3" class="text-end">Envío</th>
                    <th class="text-end">$ {{ order.deliveryCost | number:'1.0-0' }}</th>
                  </tr>
                  <tr>
                    <th colspan="3" class="text-end">Total</th>
                    <th class="text-end h5 text-petrol">
                      $ {{ order.grandTotal | number:'1.0-0' }}
                    </th>
                  </tr>
                </tfoot>
              </table>
            </div>

            <div class="d-flex gap-2 justify-content-end mt-2">
              <select class="form-select form-select-sm"
                      style="max-width: 260px"
                      [(ngModel)]="nextStatus"
                      [disabled]="options().length===0">
                <option *ngFor="let ns of options()" [ngValue]="ns">{{ ns }}</option>
              </select>
              <button class="btn btn-primary btn-sm"
                      (click)="update()"
                      [disabled]="options().length===0">
                Actualizar estado
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Resumen -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm order-summary-card">
          <div class="card-body">
            <div class="fw-semibold mb-2">Resumen</div>
            <div class="d-flex justify-content-between">
              <span>Items</span>
              <span>$ {{ order.itemsTotal | number:'1.0-0' }}</span>
            </div>
            <div class="d-flex justify-content-between" *ngIf="order.deliveryCost">
              <span>Envío</span>
              <span>$ {{ order.deliveryCost | number:'1.0-0' }}</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-semibold">
              <span>Total</span>
              <span class="h5 text-petrol">
                $ {{ order.grandTotal | number:'1.0-0' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </ng-container>
</div>

<ng-template #loadingTpl>
  <div class="container py-4"><div class="alert alert-info">Cargando…</div></div>
</ng-template>

<ng-template #errorTpl>
  <div class="container py-4">
    <div class="alert alert-danger">{{ error }}</div>
    <a routerLink="/admin/pedidos" class="btn btn-outline-secondary mt-2">Volver</a>
  </div>
</ng-template>
