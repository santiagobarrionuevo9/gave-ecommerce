<div class="container py-4 stock-page">
  <!-- Título + botón agregar -->
  <div class="d-flex justify-content-between align-items-center mb-3 stock-header">
    <div>
      <h3 class="mb-0">Actualizar stock</h3>
      <p class="text-muted small mb-0">
        Gestioná el stock de tus productos de forma rápida.
      </p>
    </div>

    <!-- BOTÓN AGREGAR PRODUCTO -->
    <a class="btn btn-primary btn-sm px-3" [routerLink]="['/admin/crear']">
      + Agregar producto
    </a>
  </div>

  <!-- Filtros -->
  <div class="card mb-3 stock-filters-card">
    <div class="card-body">
      <form class="row g-2 align-items-center" [formGroup]="form">
        <div class="col-12 col-md-6">
          <input class="form-control"
                 placeholder="Buscar por nombre, SKU…"
                 formControlName="q">
        </div>
        <div class="col-6 col-md-2">
          <select class="form-select" formControlName="sort">
            <option value="name,asc">Nombre (A→Z)</option>
            <option value="name,desc">Nombre (Z→A)</option>
            <option value="createdAt,desc">Novedades</option>
            <option value="price,asc">Precio ↑</option>
            <option value="price,desc">Precio ↓</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select class="form-select" formControlName="size">
            <option [value]="12">12</option>
            <option [value]="24">24</option>
            <option [value]="48">48</option>
          </select>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="loading()" class="alert alert-info">Cargando…</div>

  <div *ngIf="page">
    <div class="table-responsive">
      <table class="table align-middle stock-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>SKU</th>
            <th>Precio</th>
            <th>Stock</th>
            <th style="width:210px">+ / −</th>
            <th style="width:220px">Set absoluto</th>
            <th style="width:120px">Editar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of page.content"
              [class.stock-low]="p.stock <= 5">
            <td class="stock-name">
              {{ p.name }}
            </td>
            <td><code>{{ p.sku }}</code></td>
            <td class="stock-price">$ {{ p.price | number:'1.0-0' }}</td>
            <td>
              <span class="badge stock-badge">
                {{ p.stock }}
              </span>
            </td>

            <!-- SUMAR / RESTAR -->
            <td>
              <div class="stock-input-group">
                <div class="input-group input-group-sm">
                  <input type="number"
                         min="0"
                         class="form-control text-center"
                         (input)="setDelta(p.id, $any($event.target).value)"
                         placeholder="Cant.">
                  <button class="btn btn-outline-success"
                          type="button"
                          (click)="doUpdate(p,'INCREMENT')"
                          title="Sumar al stock">
                    <i class="bi bi-plus-lg"></i>
                  </button>
                  <button class="btn btn-outline-danger"
                          type="button"
                          (click)="doUpdate(p,'DECREMENT')"
                          title="Restar del stock">
                    <i class="bi bi-dash-lg"></i>
                  </button>
                </div>
                <div class="form-text small">Sumar / restar unidades</div>
              </div>
            </td>

            <!-- SET ABSOLUTO -->
            <td>
              <div class="stock-input-group">
                <div class="input-group input-group-sm">
                  <input type="number"
                         min="0"
                         class="form-control text-center"
                         (input)="setSet(p.id, $any($event.target).value)"
                         placeholder="Nuevo stock">
                  <button class="btn btn-primary"
                          type="button"
                          (click)="doUpdate(p,'SET')"
                          title="Establecer stock exacto">
                    SET
                  </button>
                </div>
                <div class="form-text small">Reemplaza el stock actual</div>
              </div>
            </td>

            <!-- BOTÓN EDITAR PRODUCTO -->
            <td>
              <a class="btn btn-sm btn-outline-secondary"
                 [routerLink]="['/admin/editar', p.id]">
                Editar
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <nav class="d-flex justify-content-end">
      <ul class="pagination mb-0">
        <li class="page-item" [class.disabled]="page.first">
          <button class="page-link" (click)="goTo(0)">&laquo;</button>
        </li>
        <li class="page-item" [class.disabled]="page.first">
          <button class="page-link" (click)="goTo((page.number||0)-1)">Anterior</button>
        </li>
        <li class="page-item disabled">
          <span class="page-link">{{ page.number + 1 }} / {{ page.totalPages }}</span>
        </li>
        <li class="page-item" [class.disabled]="page.last">
          <button class="page-link" (click)="goTo((page.number||0)+1)">Siguiente</button>
        </li>
        <li class="page-item" [class.disabled]="page.last">
          <button class="page-link" (click)="goTo(page.totalPages-1)">&raquo;</button>
        </li>
      </ul>
    </nav>
  </div>
</div>
