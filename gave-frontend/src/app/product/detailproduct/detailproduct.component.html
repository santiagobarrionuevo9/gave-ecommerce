<!-- src/app/product/detailproduct/detailproduct.component.html -->

<!-- TOAST / ALERTA FLOTANTE -->
<div *ngIf="toast()" class="position-fixed top-0 end-0 p-3" style="z-index:1080">
  <div class="toast show shadow border-0"
       [ngClass]="{'text-bg-success': toast()?.type === 'success',
                   'text-bg-danger':  toast()?.type === 'danger'}">
    <div class="d-flex align-items-center px-3 py-2">
      <div class="me-3">{{ toast()?.text }}</div>
      <button type="button" class="btn-close btn-close-white ms-auto" aria-label="Close"
              (click)="clearToast()"></button>
    </div>
  </div>
</div>

<div class="container py-4" *ngIf="!loading(); else loadingTpl">
  <ng-container *ngIf="!error; else errorTpl">

    <div class="row g-4">
      <!-- Galer√≠a simple -->
      <div class="col-12 col-lg-6">
          <!-- Contenedor relativo para poder posicionar el sem√°foro -->
          <div class="position-relative mb-3">
            <img [src]="mainImage()"
                class="img-fluid rounded shadow-sm w-100"
                [alt]="product.name" />

            <!-- Sem√°foro grande en la esquina de la imagen -->
            <div *ngIf="product.stockLevel"
                class="stock-badge-dot"
                [attr.title]="stockLevelText">
              <span class="stock-dot-big"
      [ngClass]="stockLevelClass"
      [attr.title]="stockLevelText"></span>

            </div>
          </div>


          <!-- Thumbnails -->
          <div class="d-flex gap-2 flex-wrap">
            <img *ngFor="let img of images; trackBy: trackByImgId"
                [src]="img.url"
                class="rounded border"
                style="width:90px; height:90px; object-fit:cover; cursor:pointer"
                (click)="selectAsMain(img)"
                [alt]="img.altText || product.name">
          </div>
        </div>


      <!-- Info -->
      <div class="col-12 col-lg-6">
        <h3 class="mb-2">{{ product.name }}</h3>
        <div class="text-muted mb-3" *ngIf="product.shortDesc">{{ product.shortDesc }}</div>
        <div class="h4 fw-semibold mb-1">$ {{ product.price | number:'1.0-0' }}</div>
        
        <!-- Stock: n√∫mero -->
        <div class="mb-1"
            [class.text-danger]="availableStock === 0"
            [class.text-success]="availableStock > 0">
          Stock disponible: {{ availableStock }}
        </div>

        <!-- Leyenda de colores de stock -->
        <div *ngIf="product.stockLevel" class="mb-2">
          <small class="text-muted d-block mb-1">Referencia de color:</small>
          <!-- Leyenda de colores de stock (compacta y alineada) -->
          <div class="stock-legend mt-1">
            <div class="legend-item">
              <span class="legend-dot bg-success"></span>
              <span class="legend-text">Stock saludable</span>
            </div>

            <div class="legend-item">
              <span class="legend-dot bg-warning"></span>
              <span class="legend-text">Stock moderado</span>
            </div>

            <div class="legend-item">
              <span class="legend-dot bg-danger"></span>
              <span class="legend-text">Stock cr√≠tico</span>
            </div>
          </div>
        </div>
        <!-- üîñ Promo por cantidad -->
        <div *ngIf="hasDiscount" class="alert alert-success py-2 px-3 small mb-3">
          <i class="bi bi-tag-fill me-1"></i>
          Llevando <strong>{{ discountThreshold }}</strong> o m√°s unidades,
          obten√©s un <strong>{{ discountPercent }}% de descuento</strong> en este producto.
        </div>

        <div class="d-flex align-items-center gap-2 mb-3">
          <input type="number"
                 class="form-control"
                 style="max-width:110px"
                 [(ngModel)]="qty"
                 min="1"
                 (keyup.enter)="addToCart()">

          <button class="btn btn-primary btn-lg"
                  [disabled]="product.stock===0 || isAdmin"
                  (click)="addToCart()">
            Agregar al carrito
          </button>
        </div>

        <!-- Mensajito para admins -->
        <div *ngIf="isAdmin" class="alert alert-info py-2 px-3 small">
          Est√°s ingresado como <strong>administrador</strong>, por lo que no pod√©s agregar productos al carrito.
        </div>

        <div class="mt-3">
          <h6>Descripci√≥n</h6>
          <p class="mb-0" style="white-space:pre-line">
            {{ product.description || '‚Äî' }}
          </p>
        </div>

        <div class="mt-3">
          <small class="text-muted">SKU: {{ product.sku }}</small>
        </div>
      </div>
    </div>

  </ng-container>
</div>

<ng-template #loadingTpl>
  <div class="container py-4">
    <div class="alert alert-info">Cargando producto‚Ä¶</div>
  </div>
</ng-template>

<ng-template #errorTpl>
  <div class="container py-4">
    <div class="alert alert-danger">{{ error }}</div>
    <a routerLink="/catalogo" class="btn btn-outline-secondary mt-2">Volver al cat√°logo</a>
  </div>
</ng-template>
