<div class="container py-4" *ngIf="form">
  <!-- Filtros -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <!-- usa formGroup + formControlName ✅ -->
      <form class="row g-3" [formGroup]="form">
        <div class="col-12 col-md-4">
          <label class="form-label">Buscar</label>
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Nombre, SKU..." formControlName="q">
            <button class="btn btn-outline-secondary" type="button" (click)="onClear()">Limpiar</button>
          </div>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Categoría</label>
          <select class="form-select" formControlName="typeId">
            <option [ngValue]="null">Todas</option>
            <option *ngFor="let t of types" [ngValue]="t.id">{{ t.name }}</option>
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Ordenar por</label>
          <select class="form-select" formControlName="sort">
            <option value="name,asc">Nombre (A→Z)</option>
            <option value="name,desc">Nombre (Z→A)</option>
            <option value="price,asc">Precio (menor→mayor)</option>
            <option value="price,desc">Precio (mayor→menor)</option>
          </select>
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label">Por página</label>
          <select class="form-select" formControlName="size">
            <option [value]="12">12</option>
            <option [value]="24">24</option>
            <option [value]="48">48</option>
          </select>
        </div>
      </form>
    </div>
  </div>

  <!-- Estado -->
  <div *ngIf="loading()" class="alert alert-info">Cargando productos…</div>

  <!-- Resultados -->
  <div *ngIf="page">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-muted small">{{ showingRange() }}</div>
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item" [class.disabled]="page.first">
            <button class="page-link" (click)="goTo(0)">&laquo;</button>
          </li>
          <li class="page-item" [class.disabled]="page.first">
            <button class="page-link" (click)="goTo(page.number - 1)">Anterior</button>
          </li>
          <li class="page-item disabled"><span class="page-link">{{ page.number + 1 }} / {{ page.totalPages }}</span></li>
          <li class="page-item" [class.disabled]="page.last">
            <button class="page-link" (click)="goTo(page.number + 1)">Siguiente</button>
          </li>
          <li class="page-item" [class.disabled]="page.last">
            <button class="page-link" (click)="goTo(page.totalPages - 1)">&raquo;</button>
          </li>
        </ul>
      </nav>
    </div>

    <!-- Grid -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-3">
      <div class="col" *ngFor="let p of page.content">
        <div class="card h-100 shadow-sm">
          <img class="card-img-top" [src]="getImageUrl(p)" [alt]="p.name" style="object-fit: cover; height: 200px;">
          <div class="card-body d-flex flex-column">
            <h6 class="card-title mb-1">{{ p.name }}</h6>
            <div class="text-muted small mb-2" *ngIf="p.shortDesc">{{ p.shortDesc }}</div>
            <div class="mt-auto">
              <div class="fw-semibold h5 mb-1">$ {{ p.price | number:'1.0-0' }}</div>
              <div class="small" [class.text-danger]="p.stock===0" [class.text-success]="p.stock>0">
                Stock: {{ p.stock }}
              </div>
            </div>
          </div>
          <div class="card-footer bg-transparent border-0">
            <a class="btn btn-sm btn-outline-primary w-100" [routerLink]="['/producto', p.slug]">Ver detalle</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginación inferior -->
    <div class="d-flex justify-content-end mt-3">
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item" [class.disabled]="page.first">
            <button class="page-link" (click)="goTo(page.number - 1)">Anterior</button>
          </li>
          <li class="page-item disabled"><span class="page-link">{{ page.number + 1 }} / {{ page.totalPages }}</span></li>
          <li class="page-item" [class.disabled]="page.last">
            <button class="page-link" (click)="goTo(page.number + 1)">Siguiente</button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <div *ngIf="page && page.totalElements === 0" class="alert alert-warning mt-3">
    No se encontraron productos con esos filtros.
  </div>
</div>
