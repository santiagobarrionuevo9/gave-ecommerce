<div class="container py-4" *ngIf="form">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3 admin-header">
    <div>
      <h3 class="mb-0 d-flex align-items-center gap-2">
        Editar producto

        <!-- √çcono de ayuda -->
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary rounded-circle help-icon"
          data-bs-toggle="tooltip"
          data-bs-placement="right"
          data-bs-html="true"
          title="
            <div style='max-width:320px'>
              <div class='fw-semibold mb-1'>Reglas del formulario</div>
              <ul class='mb-2 ps-3'>
                <li><b>SKU</b> obligatorio y <b>no puede repetirse</b>.</li>
                <li><b>Slug</b> obligatorio y <b>no puede repetirse</b>.</li>
                <li><b>Slug</b>: min√∫sculas, n√∫meros y guiones (ej: <code>filtro-aceite-toyota</code>).</li>
                <li><b>SKU</b>: letras/n√∫meros y <code>-</code> <code>_</code> <code>.</code> <code>/</code> (sin espacios). Se guarda en <b>MAY√öSCULAS</b>.</li>
              </ul>
              <div class='small'>
                <b>Importante:</b> en el cat√°logo vas a ver primero el <b>SKU</b> y despu√©s el <b>nombre</b>.
              </div>
            </div>
          "
          aria-label="Ayuda: reglas del formulario"
        >
          <i class="bi bi-question-lg"></i>
        </button>
      </h3>

      <p class="text-muted small mb-0">Actualiz√° y edit√° los productos de tu cat√°logo.</p>
    </div>
  </div>

  <div *ngIf="loading()" class="alert alert-info mb-3">Cargando datos‚Ä¶</div>
  <div *ngIf="saving()" class="alert alert-warning mb-3">Guardando cambios‚Ä¶</div>

  <div *ngIf="successMsg" class="alert alert-success">{{ successMsg }}</div>
  <div *ngIf="errorMsg" class="alert alert-danger">{{ errorMsg }}</div>

  <!-- FORM -->
  <div class="card shadow-sm mb-4" *ngIf="currentId !== null">
    <div class="card-body">
      <form class="row g-3" [formGroup]="form" (ngSubmit)="save()">

        <div class="col-md-6">
          <label class="form-label">Nombre *</label>
          <input type="text" class="form-control" formControlName="name" placeholder="Ej: Filtro de aceite Toyota">
          <div class="text-danger small" *ngIf="hasError('name','required')">Requerido</div>
          <div class="text-danger small" *ngIf="hasError('name','maxlength')">M√°ximo 180 caracteres</div>
        </div>

        <div class="col-md-6">
          <label class="form-label d-flex align-items-center gap-2">
            Slug *
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary rounded-circle help-icon"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              data-bs-html="true"
              title="
                <div style='max-width:280px'>
                  <div class='fw-semibold mb-1'>Reglas del Slug</div>
                  <ul class='mb-0 ps-3'>
                    <li>No puede repetirse.</li>
                    <li>Min√∫sculas, n√∫meros y guiones.</li>
                    <li>Ej: <code>filtro-aceite-toyota</code></li>
                  </ul>
                </div>
              "
              aria-label="Ayuda: reglas del slug"
            >
              <i class="bi bi-question-lg"></i>
            </button>
          </label>

          <input type="text" class="form-control" formControlName="slug" placeholder="filtro-aceite-toyota">
          <div class="text-danger small" *ngIf="hasError('slug','required')">Requerido</div>
          <div class="text-danger small" *ngIf="hasError('slug','maxlength')">M√°ximo 200 caracteres</div>
          <div class="text-danger small" *ngIf="hasError('slug','slugFormat')">
            Formato inv√°lido. Us√° min√∫sculas, n√∫meros y guiones (ej: filtro-aceite-toyota).
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label d-flex align-items-center gap-2">
            SKU *
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary rounded-circle help-icon"
              data-bs-toggle="tooltip"
              data-bs-placement="top"
              data-bs-html="true"
              title="
                <div style='max-width:300px'>
                  <div class='fw-semibold mb-1'>Reglas del SKU</div>
                  <ul class='mb-2 ps-3'>
                    <li>No puede repetirse.</li>
                    <li>Sin espacios: letras/n√∫meros y <code>-</code> <code>_</code> <code>.</code> <code>/</code></li>
                    <li>Se guarda en <b>MAY√öSCULAS</b>.</li>
                  </ul>
                  <div class='small'>
                    En el cat√°logo se ver√° primero el <b>SKU</b> y luego el <b>nombre</b>.
                  </div>
                </div>
              "
              aria-label="Ayuda: reglas del sku"
            >
              <i class="bi bi-question-lg"></i>
            </button>
          </label>

          <input type="text" class="form-control text-uppercase" formControlName="sku" placeholder="FIL/ACE-TOY-001">
          <div class="text-danger small" *ngIf="hasError('sku','required')">Requerido</div>
          <div class="text-danger small" *ngIf="hasError('sku','maxlength')">M√°ximo 64 caracteres</div>
          <div class="text-danger small" *ngIf="hasError('sku','skuFormat')">
            Formato inv√°lido. Us√° letras/n√∫meros y - _ . / (sin espacios).
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Precio *</label>
          <input type="number" class="form-control" formControlName="price" min="0" step="0.01">
          <div class="text-danger small" *ngIf="hasError('price','required')">Requerido</div>
          <div class="text-danger small" *ngIf="hasError('price','min')">Debe ser mayor a 0.</div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Stock *</label>
          <input type="number" class="form-control" formControlName="stock" min="0" step="1">
          <div class="text-danger small" *ngIf="hasError('stock','required')">Requerido</div>
          <div class="text-danger small" *ngIf="hasError('stock','min')">No puede ser negativo</div>
          <div class="text-danger small" *ngIf="hasError('stock','integer')">Debe ser un n√∫mero entero</div>
        </div>

        <!-- üåà Configuraci√≥n de sem√°foro de stock -->
        <div class="col-12 mt-2">
          <div class="border rounded p-3 bg-light">
            <h6 class="mb-3">Nivel de stock (sem√°foro)</h6>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label text-danger">üî¥ Stock cr√≠tico (peligro)</label>
                <input type="number" class="form-control" formControlName="stockLowThreshold" min="0" step="1">
                <div class="form-text">Si el stock disponible ‚â§ este valor ‚Üí rojo.</div>

                <div class="text-danger small" *ngIf="hasError('stockLowThreshold','required')">Requerido</div>
                <div class="text-danger small" *ngIf="hasError('stockLowThreshold','min')">No puede ser negativo</div>
                <div class="text-danger small" *ngIf="hasError('stockLowThreshold','integer')">Debe ser entero</div>
              </div>

              <div class="col-md-6">
                <label class="form-label text-warning">üü° Stock moderado</label>
                <input type="number" class="form-control" formControlName="stockMediumThreshold" min="0" step="1">
                <div class="form-text">Si el stock disponible ‚â§ este valor ‚Üí amarillo.</div>

                <div class="text-danger small" *ngIf="hasError('stockMediumThreshold','required')">Requerido</div>
                <div class="text-danger small" *ngIf="hasError('stockMediumThreshold','min')">No puede ser negativo</div>
                <div class="text-danger small" *ngIf="hasError('stockMediumThreshold','integer')">Debe ser entero</div>
              </div>
            </div>

            <div class="text-danger small mt-2" *ngIf="(form.touched || submitted) && form.hasError('thresholdsOrder')">
              El ‚ÄúStock cr√≠tico‚Äù debe ser menor o igual al ‚ÄúStock moderado‚Äù.
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Categor√≠a *</label>
          <select class="form-select" formControlName="typeId">
            <option [ngValue]="null">Seleccionar‚Ä¶</option>
            <option *ngFor="let t of types" [ngValue]="t.id">{{ t.name }}</option>
          </select>
          <div class="text-danger small" *ngIf="hasError('typeId','required')">Requerido</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Activo</label>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" formControlName="isActive">
            <label class="form-check-label">Visible en cat√°logo</label>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Descripci√≥n corta</label>
          <input type="text" class="form-control" formControlName="shortDesc" maxlength="300">
          <div class="text-danger small" *ngIf="hasError('shortDesc','maxlength')">M√°ximo 300 caracteres</div>
        </div>

        <div class="col-12">
          <label class="form-label">Descripci√≥n</label>
          <textarea rows="5" class="form-control" formControlName="description" placeholder="Detalles del producto"></textarea>
        </div>

        <!-- üîß Config de descuentos -->
        <div class="col-12 d-flex justify-content-between align-items-center mt-2">
          <div class="text-muted small">Descuentos por cantidad (opcionales)</div>
          <button type="button"
                  class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center"
                  (click)="showDiscountConfig = !showDiscountConfig">
            <i class="bi bi-gear me-1"></i>
            Configurar descuentos
          </button>
        </div>

        <div class="col-12 mt-2" *ngIf="showDiscountConfig">
          <div class="border rounded p-3 bg-light">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Cantidad m√≠nima para aplicar descuento</label>
                <input type="number" class="form-control" formControlName="discountThreshold" min="1" step="1">
                <div class="text-danger small" *ngIf="hasError('discountThreshold','min')">Debe ser m√≠nimo 1</div>
                <div class="text-danger small" *ngIf="hasError('discountThreshold','integer')">Debe ser entero</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">% de descuento sobre esa l√≠nea</label>
                <div class="input-group">
                  <input type="number" class="form-control" formControlName="discountPercent" min="0" max="100" step="0.01">
                  <span class="input-group-text">%</span>
                </div>
                <div class="text-danger small" *ngIf="hasError('discountPercent','min')">No puede ser negativo</div>
                <div class="text-danger small" *ngIf="hasError('discountPercent','max')">No puede superar 100</div>
              </div>
            </div>

            <div class="text-danger small mt-2" *ngIf="(form.touched || submitted) && form.hasError('discountPercentRequired')">
              Si complet√°s la cantidad m√≠nima, tambi√©n ten√©s que completar el % de descuento.
            </div>

            <div class="text-danger small mt-2" *ngIf="(form.touched || submitted) && form.hasError('discountThresholdRequired')">
              Si complet√°s el % de descuento, tambi√©n ten√©s que completar la cantidad m√≠nima.
            </div>
          </div>
        </div>

        <div class="col-12 d-flex justify-content-end mt-3 gap-2">
          <a routerLink="/admin/stock" class="btn btn-outline-secondary">Volver</a>

          <button class="btn btn-primary" type="submit" [disabled]="saving()">
            Guardar cambios
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- Gesti√≥n de im√°genes -->
  <div class="card shadow-sm" *ngIf="currentId !== null">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Im√°genes del producto</h5>
        <span *ngIf="imgLoading()" class="text-info small">Actualizando‚Ä¶</span>
      </div>

      <div class="table-responsive" *ngIf="images.length; else noImgs">
        <table class="table align-middle">
          <thead>
            <tr>
              <th style="width:110px">Miniatura</th>
              <th>URL</th>
              <th style="width:240px">Alt text</th>
              <th style="width:120px">Orden</th>
              <th style="width:210px"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let img of images">
              <td>
                <img [src]="abs(img.url)" class="rounded border" style="width:100px; height:70px; object-fit:cover;">
              </td>
              <td class="small"><code>{{ img.url }}</code></td>
              <td>
                <ng-container *ngIf="!img._editing; else editAlt">
                  {{ img.altText || '-' }}
                </ng-container>
                <ng-template #editAlt>
                  <input type="text"
                         class="form-control form-control-sm"
                         [(ngModel)]="img._alt"
                         [ngModelOptions]="{ standalone: true }">
                </ng-template>
              </td>
              <td>
                <ng-container *ngIf="!img._editing; else editSort">
                  {{ img.sortOrder ?? 0 }}
                </ng-container>
                <ng-template #editSort>
                  <input type="number"
                         class="form-control form-control-sm"
                         [(ngModel)]="img._sort"
                         [ngModelOptions]="{ standalone: true }"
                         min="0" step="1">
                </ng-template>
              </td>
              <td class="text-end">
                <button *ngIf="!img._editing"
                        class="btn btn-sm btn-outline-primary me-2"
                        type="button"
                        (click)="startEdit(img)">
                  Editar
                </button>

                <button *ngIf="img._editing"
                        class="btn btn-sm btn-primary me-2"
                        type="button"
                        (click)="saveImage(img)">
                  Guardar
                </button>

                <button *ngIf="img._editing"
                        class="btn btn-sm btn-secondary me-2"
                        type="button"
                        (click)="cancelEdit(img)">
                  Cancelar
                </button>

                <button class="btn btn-sm btn-outline-danger"
                        type="button"
                        (click)="deleteImage(img)">
                  Eliminar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #noImgs>
        <div class="alert alert-warning">Este producto no tiene im√°genes.</div>
      </ng-template>

      <hr>

      <div class="row g-2">
        <div class="col-md-8">
          <label class="form-label">Agregar nuevas im√°genes</label>
          <input type="file"
                 class="form-control"
                 (change)="onFilesChange($event)"
                 accept="image/*"
                 multiple>
          <div class="form-text">
            Hasta {{ MAX_FILES }} im√°genes (m√°x {{ MAX_MB }} MB c/u).
          </div>
        </div>

        <div class="col-md-4 d-flex align-items-end justify-content-end">
          <button class="btn btn-outline-secondary me-2"
                  type="button"
                  (click)="clearUploads()"
                  [disabled]="!previews.length">
            Limpiar selecci√≥n
          </button>

          <button class="btn btn-success"
                  type="button"
                  (click)="uploadSelected()"
                  [disabled]="!previews.length || imgLoading()">
            Subir seleccionadas
          </button>
        </div>
      </div>

      <div class="row g-2 mt-2" *ngIf="previews.length">
        <div class="col-6 col-md-3 col-lg-2" *ngFor="let p of previews">
          <img [src]="p" class="img-fluid rounded border" style="height:110px; object-fit:cover;">
        </div>
      </div>
    </div>
  </div>
</div>
